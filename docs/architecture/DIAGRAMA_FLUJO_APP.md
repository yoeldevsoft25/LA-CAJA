# LA-CAJA - Diagrama de Flujo y Checkpoint de la Aplicación

## Arquitectura General

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              LA-CAJA POS SYSTEM                                  │
│                         Arquitectura Offline-First                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │   PWA App    │    │ Desktop App  │    │   API NestJS │    │  PostgreSQL  │  │
│  │   (React)    │◄───┤   (Tauri)    │    │  (Fastify)   │◄───┤   Database   │  │
│  └──────┬───────┘    └──────────────┘    └──────▲───────┘    └──────────────┘  │
│         │                                        │                              │
│         └────────────────────────────────────────┘                              │
│                    SYNC SERVICE (WebSocket + REST)                              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 1. FLUJO PRINCIPAL DE AUTENTICACIÓN

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           CHECKPOINT: AUTENTICACIÓN                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────┐                                                               │
│   │  Usuario    │                                                               │
│   │  Ingresa    │                                                               │
│   └──────┬──────┘                                                               │
│          │                                                                       │
│          ▼                                                                       │
│   ┌─────────────┐     ┌─────────────┐                                          │
│   │ LandingPage │────►│  LoginPage  │                                          │
│   └─────────────┘     └──────┬──────┘                                          │
│                              │                                                   │
│                    ┌─────────┴─────────┐                                        │
│                    ▼                   ▼                                        │
│            ┌──────────────┐    ┌──────────────┐                                │
│            │   Credenciales   │    │ Token Válido │                                │
│            │   Válidas?    │    │ en Storage?  │                                │
│            └───────┬──────┘    └───────┬──────┘                                │
│                    │                   │                                        │
│          ┌─────────┴─────────┐         │                                        │
│          ▼                   ▼         │                                        │
│   ┌────────────┐      ┌────────────┐   │                                        │
│   │    NO      │      │    SI      │◄──┘                                        │
│   │  Error     │      │  Login     │                                            │
│   └────────────┘      └─────┬──────┘                                            │
│                             │                                                   │
│                             ▼                                                   │
│                    ┌──────────────────┐                                         │
│                    │   auth.store.ts  │                                         │
│                    │  ┌────────────┐  │                                         │
│                    │  │ user       │  │                                         │
│                    │  │ token      │  │                                         │
│                    │  │ store_id   │  │                                         │
│                    │  │ role       │  │                                         │
│                    │  └────────────┘  │                                         │
│                    └────────┬─────────┘                                         │
│                             │                                                   │
│                    ┌────────┴────────┐                                          │
│                    ▼                 ▼                                          │
│             ┌──────────┐      ┌──────────┐                                      │
│             │  OWNER   │      │ CASHIER  │                                      │
│             │ Dashboard│      │   POS    │                                      │
│             └──────────┘      └──────────┘                                      │
│                                                                                  │
│  VALIDACIONES:                                                                   │
│  ☑ Licencia activa                                                              │
│  ☑ Store_id válido                                                              │
│  ☑ Token JWT válido                                                             │
│  ☑ Refresh token disponible                                                     │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. FLUJO DE VENTAS (POS) - FLUJO CRÍTICO

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         CHECKPOINT: FLUJO DE VENTAS                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────┐                                                                │
│  │   POSPage   │◄──────────────────────────────────────────────────┐            │
│  └──────┬──────┘                                                   │            │
│         │                                                          │            │
│  ┌──────┴──────────────────────────────────────────┐              │            │
│  │                                                  │              │            │
│  ▼                                                  ▼              │            │
│  ┌────────────────┐                    ┌────────────────┐         │            │
│  │ ProductSearch  │                    │   CartStore    │         │            │
│  │ ┌────────────┐ │                    │ ┌────────────┐ │         │            │
│  │ │ Barcode    │ │ ──addItem()──────► │ │  items[]   │ │         │            │
│  │ │ Name Search│ │                    │ │  totals    │ │         │            │
│  │ │ Categories │ │                    │ │  discounts │ │         │            │
│  │ └────────────┘ │                    │ └────────────┘ │         │            │
│  └────────────────┘                    └───────┬────────┘         │            │
│         │                                      │                   │            │
│         │                            ┌─────────┴─────────┐        │            │
│         │                            ▼                   ▼        │            │
│         │              ┌──────────────────┐   ┌──────────────┐   │            │
│         │              │ WeightInputModal │   │ Producto con │   │            │
│         │              │ (productos peso) │   │ Variantes?   │   │            │
│         │              └────────┬─────────┘   └───────┬──────┘   │            │
│         │                       │                     │           │            │
│         │                       │         ┌───────────┴────────┐ │            │
│         │                       │         ▼                    ▼ │            │
│         │                       │  ┌────────────┐   ┌────────────┐            │
│         │                       │  │ Variant    │   │ Serial     │            │
│         │                       │  │ Selection  │   │ Selection  │            │
│         │                       │  └────────────┘   └────────────┘            │
│         │                       │         │                │                   │
│         │                       └─────────┴────────────────┘                   │
│         │                                 │                                    │
│         │                                 ▼                                    │
│         │                    ┌─────────────────────┐                          │
│         │                    │  Item agregado al   │                          │
│         │                    │       Carrito       │                          │
│         │                    └──────────┬──────────┘                          │
│         │                               │                                      │
│         │                               ▼                                      │
│         │                    ┌─────────────────────┐                          │
│         │                    │   CHECKOUT MODAL    │◄────────────────┐        │
│         │                    │                     │                  │        │
│         │                    │ ┌─────────────────┐ │                  │        │
│         │                    │ │ 1. Cliente      │ │    CustomerForm  │        │
│         │                    │ │    (opcional)   │─┼────► Modal       │        │
│         │                    │ └────────┬────────┘ │                  │        │
│         │                    │          ▼          │                  │        │
│         │                    │ ┌─────────────────┐ │                  │        │
│         │                    │ │ 2. Método Pago  │ │                  │        │
│         │                    │ │  ┌───────────┐  │ │                  │        │
│         │                    │ │  │ CASH_BS   │  │ │                  │        │
│         │                    │ │  │ CASH_USD  │  │ │                  │        │
│         │                    │ │  │ TRANSFER  │  │ │                  │        │
│         │                    │ │  │ PAGO_MOVIL│  │ │                  │        │
│         │                    │ │  │ SPLIT     │──┼─┼──► SplitPayment  │        │
│         │                    │ │  └───────────┘  │ │       Modal      │        │
│         │                    │ └────────┬────────┘ │                  │        │
│         │                    │          ▼          │                  │        │
│         │                    │ ┌─────────────────┐ │                  │        │
│         │                    │ │ 3. Descuentos   │ │   Discount      │        │
│         │                    │ │    (opcional)   │─┼──► Authorization │        │
│         │                    │ └────────┬────────┘ │      Modal      │        │
│         │                    │          ▼          │                  │        │
│         │                    │ ┌─────────────────┐ │                  │        │
│         │                    │ │ 4. Confirmar    │ │                  │        │
│         │                    │ │    Venta        │ │                  │        │
│         │                    │ └────────┬────────┘ │                  │        │
│         │                    └──────────┼──────────┘                  │        │
│         │                               │                              │        │
│         │                               ▼                              │        │
│         │                    ┌─────────────────────┐                  │        │
│         │                    │  SalesService       │                  │        │
│         │                    │  .create()          │                  │        │
│         │                    └──────────┬──────────┘                  │        │
│         │                               │                              │        │
│         │                    ┌──────────┴──────────┐                  │        │
│         │                    ▼                     ▼                  │        │
│         │         ┌──────────────────┐   ┌──────────────────┐        │        │
│         │         │ Local IndexedDB  │   │  Sync to Server  │        │        │
│         │         │ (offline mode)   │   │  (online mode)   │        │        │
│         │         └──────────────────┘   └──────────────────┘        │        │
│         │                    │                     │                  │        │
│         │                    └──────────┬──────────┘                  │        │
│         │                               ▼                              │        │
│         │                    ┌─────────────────────┐                  │        │
│         │                    │  Venta Creada       │                  │        │
│         │                    │  ┌───────────────┐  │                  │        │
│         │                    │  │ sale_id       │  │                  │        │
│         │                    │  │ items[]       │  │                  │        │
│         │                    │  │ total         │  │                  │        │
│         │                    │  │ payments[]    │  │                  │        │
│         │                    │  │ customer_id?  │  │                  │        │
│         │                    │  └───────────────┘  │                  │        │
│         │                    └──────────┬──────────┘                  │        │
│         │                               │                              │        │
│         │                    ┌──────────┴──────────┐                  │        │
│         │                    ▼                     ▼                  │        │
│         │         ┌──────────────────┐   ┌──────────────────┐        │        │
│         │         │  Print Receipt   │   │ Generar Factura  │        │        │
│         │         │  (PrintService)  │   │ Fiscal?          │        │        │
│         │         └──────────────────┘   └────────┬─────────┘        │        │
│         │                                         │                   │        │
│         │                                         ▼                   │        │
│         │                              ┌─────────────────────┐       │        │
│         │                              │CreateFiscalInvoice  │       │        │
│         │                              │FromSaleModal        │       │        │
│         │                              └─────────────────────┘       │        │
│         │                                                             │        │
│         └─────────────────────────────────────────────────────────────┘        │
│                                                                                  │
│  VALIDACIONES CRÍTICAS:                                                         │
│  ☑ Sesión de caja abierta (CashSession activa)                                 │
│  ☑ Stock suficiente para cada producto                                         │
│  ☑ Precios actualizados (multi-moneda BS/USD)                                  │
│  ☑ Descuentos autorizados si aplica                                            │
│  ☑ Seriales únicos capturados si producto lo requiere                          │
│  ☑ Peso capturado si producto es por peso                                      │
│  ☑ Método de pago válido y configurado                                         │
│  ☑ Cambio calculado correctamente                                              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. FLUJO DE CAJA Y SESIONES

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        CHECKPOINT: GESTIÓN DE CAJA                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐            │
│  │                         CashPage                                 │            │
│  └─────────────────────────────────────────────────────────────────┘            │
│                                │                                                 │
│         ┌─────────────────────┼─────────────────────┐                           │
│         ▼                     ▼                     ▼                           │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐                     │
│  │ Sin Sesión  │      │  Sesión     │      │  Ver        │                     │
│  │ Activa      │      │  Activa     │      │  Historial  │                     │
│  └──────┬──────┘      └──────┬──────┘      └──────┬──────┘                     │
│         │                    │                    │                             │
│         ▼                    │                    ▼                             │
│  ┌─────────────────┐         │          ┌──────────────────┐                   │
│  │ OpenCashModal   │         │          │CashSessionDetail │                   │
│  │                 │         │          │Modal             │                   │
│  │ ┌─────────────┐ │         │          │ ┌──────────────┐ │                   │
│  │ │ Monto       │ │         │          │ │ Ventas       │ │                   │
│  │ │ Inicial BS  │ │         │          │ │ Movimientos  │ │                   │
│  │ │ Inicial USD │ │         │          │ │ Totales      │ │                   │
│  │ │ Notas       │ │         │          │ │ Diferencias  │ │                   │
│  │ └─────────────┘ │         │          │ └──────────────┘ │                   │
│  └────────┬────────┘         │          └──────────────────┘                   │
│           │                  │                                                  │
│           ▼                  │                                                  │
│  ┌──────────────────┐        │                                                  │
│  │ CashSession      │◄───────┘                                                  │
│  │ Creada/Activa    │                                                          │
│  └────────┬─────────┘                                                          │
│           │                                                                     │
│    ┌──────┴────────────────────────────────┐                                   │
│    ▼                                       ▼                                   │
│  ┌────────────────────┐        ┌─────────────────────┐                         │
│  │ CashMovementModal  │        │   CloseCashModal    │                         │
│  │                    │        │                     │                         │
│  │ ┌────────────────┐ │        │ ┌─────────────────┐ │                         │
│  │ │ Tipo:          │ │        │ │ Conteo Físico:  │ │                         │
│  │ │ - Entrada      │ │        │ │ - Efectivo BS   │ │                         │
│  │ │ - Salida       │ │        │ │ - Efectivo USD  │ │                         │
│  │ │ - Retiro       │ │        │ │ Diferencia      │ │                         │
│  │ │ Monto          │ │        │ │ Notas           │ │                         │
│  │ │ Concepto       │ │        │ └─────────────────┘ │                         │
│  │ └────────────────┘ │        └──────────┬──────────┘                         │
│  └────────────────────┘                   │                                    │
│                                           ▼                                    │
│                              ┌─────────────────────┐                           │
│                              │  Sesión Cerrada     │                           │
│                              │  ┌───────────────┐  │                           │
│                              │  │ total_ventas  │  │                           │
│                              │  │ diferencia    │  │                           │
│                              │  │ closed_at     │  │                           │
│                              │  └───────────────┘  │                           │
│                              └─────────────────────┘                           │
│                                                                                  │
│  VALIDACIONES:                                                                   │
│  ☑ Solo una sesión activa por usuario                                          │
│  ☑ No permitir ventas sin sesión abierta                                       │
│  ☑ Conteo físico obligatorio al cerrar                                         │
│  ☑ Diferencias registradas y justificadas                                      │
│  ☑ Movimientos de caja documentados                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. FLUJO DE PRODUCTOS E INVENTARIO

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       CHECKPOINT: GESTIÓN DE PRODUCTOS                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐            │
│  │                       ProductsPage                               │            │
│  └──────────────────────────────┬──────────────────────────────────┘            │
│                                 │                                               │
│    ┌──────────────┬─────────────┼─────────────┬──────────────┐                 │
│    ▼              ▼             ▼             ▼              ▼                 │
│ ┌────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│ │ Nuevo  │  │  Editar  │  │  Import  │  │  Bulk    │  │  Clean   │            │
│ │Producto│  │ Producto │  │   CSV    │  │  Price   │  │  Dupes   │            │
│ └───┬────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘            │
│     │            │             │             │             │                   │
│     └────────────┴─────────────┘             │             │                   │
│                  │                           │             │                   │
│                  ▼                           ▼             ▼                   │
│     ┌─────────────────────────┐   ┌──────────────┐  ┌──────────────┐          │
│     │   ProductFormModal      │   │BulkPriceChange│  │CleanDuplicates│          │
│     │                         │   │Modal          │  │Modal          │          │
│     │ ┌─────────────────────┐ │   └──────────────┘  └──────────────┘          │
│     │ │ Información Básica  │ │                                                │
│     │ │ - nombre            │ │                                                │
│     │ │ - código/barcode    │ │                                                │
│     │ │ - categoría         │ │                                                │
│     │ │ - descripción       │ │                                                │
│     │ └─────────┬───────────┘ │                                                │
│     │           ▼             │                                                │
│     │ ┌─────────────────────┐ │                                                │
│     │ │ Precios Multi-Moneda│ │                                                │
│     │ │ - precio_bs         │ │                                                │
│     │ │ - precio_usd        │ │                                                │
│     │ │ - costo             │ │                                                │
│     │ └─────────┬───────────┘ │                                                │
│     │           ▼             │                                                │
│     │ ┌─────────────────────┐ │         ┌───────────────────────┐              │
│     │ │ Tipo de Producto    │─┼────────►│ ProductVariantsModal  │              │
│     │ │ - Standard          │ │         │ (si tiene variantes)  │              │
│     │ │ - Serializado       │─┼───┐     └───────────────────────┘              │
│     │ │ - Por Peso          │ │   │                                            │
│     │ │ - Con Lotes         │─┼───┼───►┌───────────────────────┐              │
│     │ └─────────────────────┘ │   │    │  ProductLotsModal     │              │
│     │                         │   │    │  (si tiene lotes)     │              │
│     │ ┌─────────────────────┐ │   │    └───────────────────────┘              │
│     │ │ Stock Inicial       │ │   │                                            │
│     │ │ - cantidad          │ │   └───►┌───────────────────────┐              │
│     │ │ - almacén           │ │        │  ProductSerialsModal  │              │
│     │ │ - stock_min         │ │        │  (si serializado)     │              │
│     │ └─────────────────────┘ │        └───────────────────────┘              │
│     └───────────┬─────────────┘                                                │
│                 │                                                               │
│                 ▼                                                               │
│     ┌─────────────────────────┐                                                │
│     │   Producto Guardado     │                                                │
│     │   + Stock Inicial       │                                                │
│     └─────────────────────────┘                                                │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐            │
│  │                       InventoryPage                              │            │
│  └──────────────────────────────┬──────────────────────────────────┘            │
│                                 │                                               │
│         ┌───────────────────────┼───────────────────────┐                       │
│         ▼                       ▼                       ▼                       │
│  ┌──────────────┐       ┌──────────────┐       ┌──────────────┐                │
│  │StockReceived │       │ StockAdjust  │       │ Movements    │                │
│  │Modal         │       │ Modal        │       │ Modal        │                │
│  │              │       │              │       │              │                │
│  │ ┌──────────┐ │       │ ┌──────────┐ │       │ ┌──────────┐ │                │
│  │ │producto  │ │       │ │producto  │ │       │ │historial │ │                │
│  │ │cantidad  │ │       │ │cantidad  │ │       │ │por       │ │                │
│  │ │proveedor │ │       │ │motivo    │ │       │ │producto  │ │                │
│  │ │lote?     │ │       │ │notas     │ │       │ └──────────┘ │                │
│  │ │seriales? │ │       │ └──────────┘ │       └──────────────┘                │
│  │ └──────────┘ │       └──────────────┘                                       │
│  └──────────────┘                                                               │
│                                                                                  │
│  VALIDACIONES:                                                                   │
│  ☑ Código/barcode único                                                         │
│  ☑ Precios en ambas monedas                                                     │
│  ☑ Stock no puede ser negativo                                                  │
│  ☑ Seriales únicos para productos serializados                                  │
│  ☑ Lotes con fecha de vencimiento si aplica                                    │
│  ☑ Variantes con SKU único                                                      │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. FLUJO DE CLIENTES Y DEUDAS

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       CHECKPOINT: CLIENTES Y DEUDAS                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐            │
│  │                       CustomersPage                              │            │
│  └──────────────────────────────┬──────────────────────────────────┘            │
│                                 │                                               │
│              ┌──────────────────┴──────────────────┐                           │
│              ▼                                     ▼                           │
│     ┌──────────────────┐                 ┌──────────────────┐                  │
│     │ CustomerFormModal│                 │  Ver Deudas      │                  │
│     │                  │                 │  del Cliente     │                  │
│     │ ┌──────────────┐ │                 └────────┬─────────┘                  │
│     │ │ nombre       │ │                          │                            │
│     │ │ telefono     │ │                          ▼                            │
│     │ │ email        │ │                 ┌──────────────────┐                  │
│     │ │ direccion    │ │                 │   DebtsPage      │                  │
│     │ │ rif/cedula   │ │                 └────────┬─────────┘                  │
│     │ │ limite_credito│ │                          │                            │
│     │ └──────────────┘ │            ┌─────────────┴─────────────┐              │
│     └────────┬─────────┘            ▼                           ▼              │
│              │             ┌──────────────────┐       ┌──────────────────┐     │
│              ▼             │ DebtDetailModal  │       │  AddPaymentModal │     │
│     ┌──────────────────┐   │                  │       │                  │     │
│     │ Cliente Guardado │   │ ┌──────────────┐ │       │ ┌──────────────┐ │     │
│     │                  │   │ │ monto_total  │ │       │ │ monto        │ │     │
│     │ ┌──────────────┐ │   │ │ monto_pagado │ │       │ │ metodo_pago  │ │     │
│     │ │ Puede usarse │ │   │ │ saldo        │ │       │ │ referencia   │ │     │
│     │ │ en ventas    │ │   │ │ fecha_limite │ │       │ │ notas        │ │     │
│     │ │ a crédito    │ │   │ │ pagos[]      │ │       │ └──────────────┘ │     │
│     │ └──────────────┘ │   │ └──────────────┘ │       └────────┬─────────┘     │
│     └──────────────────┘   └──────────────────┘                │               │
│                                                                 │               │
│                                                                 ▼               │
│                                                    ┌─────────────────────┐      │
│                                                    │  Pago Registrado    │      │
│                                                    │  Saldo Actualizado  │      │
│                                                    └─────────────────────┘      │
│                                                                                  │
│  FLUJO DE VENTA A CRÉDITO:                                                      │
│                                                                                  │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐                  │
│  │ Checkout │───►│ Seleccionar───►│ Verificar │───►│ Crear    │                  │
│  │ Modal    │    │ Cliente  │    │ Límite   │    │ Deuda    │                  │
│  └──────────┘    └──────────┘    │ Crédito  │    └──────────┘                  │
│                                  └──────────┘                                   │
│                                                                                  │
│  VALIDACIONES:                                                                   │
│  ☑ Cliente con datos fiscales para facturación                                 │
│  ☑ Límite de crédito no excedido                                               │
│  ☑ Pagos no pueden exceder saldo pendiente                                     │
│  ☑ Historial de pagos completo                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. FLUJO DE ÓRDENES (MESAS/RESTAURANTE)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      CHECKPOINT: GESTIÓN DE ÓRDENES                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐            │
│  │                        TablesPage                                │            │
│  └──────────────────────────────┬──────────────────────────────────┘            │
│                                 │                                               │
│         ┌───────────────────────┼───────────────────────┐                       │
│         ▼                       ▼                       ▼                       │
│  ┌──────────────┐       ┌──────────────┐       ┌──────────────┐                │
│  │ Mesa Libre   │       │Mesa Ocupada  │       │ TableModal   │                │
│  │              │       │ (con orden)  │       │ (config)     │                │
│  └──────┬───────┘       └──────┬───────┘       └──────────────┘                │
│         │                      │                                                │
│         ▼                      ▼                                                │
│  ┌──────────────────┐   ┌──────────────────┐                                   │
│  │   OrderModal     │   │   OrderModal     │                                   │
│  │   (Nueva Orden)  │   │(Orden Existente) │                                   │
│  │                  │   │                  │                                   │
│  │ ┌──────────────┐ │   │ ┌──────────────┐ │                                   │
│  │ │ Agregar      │ │   │ │ Ver Items    │ │                                   │
│  │ │ Productos    │ │   │ │ Modificar    │ │                                   │
│  │ └──────┬───────┘ │   │ │ Agregar más  │ │                                   │
│  │        │         │   │ └──────┬───────┘ │                                   │
│  │        ▼         │   │        │         │                                   │
│  │ ┌──────────────┐ │   │        ▼         │                                   │
│  │ │OrderItemModal│ │   │ ┌──────────────┐ │                                   │
│  │ │ - cantidad   │ │   │ │OrderItemModal│ │                                   │
│  │ │ - notas      │ │   │ │ (editar item)│ │                                   │
│  │ │ - modificadores│   │ └──────────────┘ │                                   │
│  │ └──────────────┘ │   │                  │                                   │
│  └────────┬─────────┘   └────────┬─────────┘                                   │
│           │                      │                                              │
│           └──────────┬───────────┘                                              │
│                      │                                                          │
│           ┌──────────┴──────────┐                                              │
│           ▼                     ▼                                              │
│  ┌──────────────────┐   ┌──────────────────┐                                   │
│  │PartialPayment   │   │  Cerrar Orden    │                                   │
│  │Modal            │   │  (Total)         │                                   │
│  │                 │   │                  │                                   │
│  │ ┌─────────────┐ │   │  ┌────────────┐  │                                   │
│  │ │ Pago        │ │   │  │ Checkout   │  │                                   │
│  │ │ Parcial     │ │   │  │ Modal      │  │                                   │
│  │ │ Divide mesa │ │   │  └────────────┘  │                                   │
│  │ └─────────────┘ │   │                  │                                   │
│  └────────┬────────┘   └────────┬─────────┘                                   │
│           │                     │                                              │
│           └──────────┬──────────┘                                              │
│                      ▼                                                          │
│           ┌─────────────────────┐                                              │
│           │  Venta Generada     │                                              │
│           │  Mesa Liberada      │                                              │
│           └─────────────────────┘                                              │
│                                                                                  │
│  VALIDACIONES:                                                                   │
│  ☑ Mesa disponible para nueva orden                                            │
│  ☑ Items con stock disponible                                                  │
│  ☑ Pagos parciales no exceden total                                            │
│  ☑ Orden debe cerrarse completamente antes de liberar mesa                     │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. FLUJO DE COMPRAS Y PROVEEDORES

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     CHECKPOINT: ÓRDENES DE COMPRA                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐            │
│  │                    PurchaseOrdersPage                            │            │
│  └──────────────────────────────┬──────────────────────────────────┘            │
│                                 │                                               │
│         ┌───────────────────────┼───────────────────────┐                       │
│         ▼                       ▼                       ▼                       │
│  ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐            │
│  │PurchaseOrderForm │   │PurchaseOrderDetail│   │PurchaseOrder    │            │
│  │Modal             │   │Modal              │   │ReceptionModal   │            │
│  │                  │   │                   │   │                 │            │
│  │ ┌──────────────┐ │   │ ┌───────────────┐ │   │ ┌─────────────┐ │            │
│  │ │ proveedor    │ │   │ │ Estado:       │ │   │ │ Recepción   │ │            │
│  │ │ productos[]  │ │   │ │ - Pendiente   │ │   │ │ - cantidad  │ │            │
│  │ │ cantidades   │ │   │ │ - Parcial     │ │   │ │ - lote?     │ │            │
│  │ │ precios      │ │   │ │ - Completada  │ │   │ │ - seriales? │ │            │
│  │ │ fecha_entrega│ │   │ │ - Cancelada   │ │   │ │ - almacén   │ │            │
│  │ └──────────────┘ │   │ └───────────────┘ │   │ └─────────────┘ │            │
│  └────────┬─────────┘   └───────────────────┘   └───────┬─────────┘            │
│           │                                             │                       │
│           ▼                                             ▼                       │
│  ┌──────────────────┐                        ┌──────────────────┐              │
│  │ Orden Creada     │                        │ Stock Actualizado│              │
│  │ Estado: Pendiente│                        │ Movimiento       │              │
│  └──────────────────┘                        │ Registrado       │              │
│                                              └──────────────────┘              │
│                                                                                  │
│  FLUJO COMPLETO:                                                                │
│                                                                                  │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐          │
│  │ Crear   │──►│ Aprobar │──►│ Enviar a│──►│ Recibir │──►│ Stock   │          │
│  │ Orden   │   │ (Owner) │   │Proveedor│   │ Mercancía   │ Actualizado│          │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘   └─────────┘          │
│                                                                                  │
│  VALIDACIONES:                                                                   │
│  ☑ Proveedor activo en el sistema                                              │
│  ☑ Productos existen en catálogo                                               │
│  ☑ Cantidades recibidas <= cantidades ordenadas                                │
│  ☑ Seriales únicos al recibir productos serializados                          │
│  ☑ Lotes con información completa                                              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. FLUJO DE SINCRONIZACIÓN (CRÍTICO)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      CHECKPOINT: SINCRONIZACIÓN                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                         ARQUITECTURA OFFLINE-FIRST                         │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│                           ┌─────────────────────┐                               │
│                           │    Acción Usuario   │                               │
│                           │  (Venta, Producto,  │                               │
│                           │   Inventario, etc)  │                               │
│                           └──────────┬──────────┘                               │
│                                      │                                          │
│                                      ▼                                          │
│                           ┌─────────────────────┐                               │
│                           │   Crear LocalEvent  │                               │
│                           │   (IndexedDB)       │                               │
│                           └──────────┬──────────┘                               │
│                                      │                                          │
│                      ┌───────────────┴───────────────┐                         │
│                      ▼                               ▼                         │
│            ┌─────────────────┐             ┌─────────────────┐                 │
│            │    ONLINE       │             │    OFFLINE      │                 │
│            └────────┬────────┘             └────────┬────────┘                 │
│                     │                               │                          │
│                     ▼                               ▼                          │
│            ┌─────────────────┐             ┌─────────────────┐                 │
│            │  SyncService    │             │  Evento en Cola │                 │
│            │  .push()        │             │  Local          │                 │
│            └────────┬────────┘             └────────┬────────┘                 │
│                     │                               │                          │
│                     ▼                               │                          │
│            ┌─────────────────┐                      │                          │
│            │  POST /sync/push │                      │                          │
│            │  (batch events)  │                      │                          │
│            └────────┬────────┘                      │                          │
│                     │                               │                          │
│         ┌───────────┴───────────┐                  │                          │
│         ▼                       ▼                  │                          │
│  ┌─────────────┐         ┌─────────────┐           │                          │
│  │  ACCEPTED   │         │ CONFLICTED  │           │                          │
│  │  (éxito)    │         │ (conflicto) │           │                          │
│  └──────┬──────┘         └──────┬──────┘           │                          │
│         │                       │                  │                          │
│         ▼                       ▼                  │                          │
│  ┌─────────────┐         ┌─────────────┐           │                          │
│  │ Invalidar   │         │ ConflictsPage│           │                          │
│  │ Query Cache │         │ Resolver     │           │                          │
│  └─────────────┘         │ Manualmente  │           │                          │
│                          └─────────────┘           │                          │
│                                                     │                          │
│  CUANDO VUELVE ONLINE: ◄────────────────────────────┘                          │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      VECTOR CLOCK SYNC                                   │   │
│  │                                                                          │   │
│  │   Cliente                              Servidor                         │   │
│  │   ┌──────────────┐                    ┌──────────────┐                  │   │
│  │   │ vector_clock │ ──── PUSH ────────►│ vector_clock │                  │   │
│  │   │ {A: 5, B: 3} │                    │ {A: 4, B: 5} │                  │   │
│  │   └──────────────┘                    └──────┬───────┘                  │   │
│  │                                              │                          │   │
│  │                        ┌─────────────────────┴─────────────────┐        │   │
│  │                        ▼                                       ▼        │   │
│  │                 ┌─────────────┐                         ┌─────────────┐ │   │
│  │                 │  MERGE OK   │                         │  CONFLICT   │ │   │
│  │                 │ A: max(5,4) │                         │  Detectado  │ │   │
│  │                 │ B: max(3,5) │                         └─────────────┘ │   │
│  │                 └─────────────┘                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  CIRCUIT BREAKER:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Failures: 0 ───► 1 ───► 2 ───► 3 ───► OPEN (stop requests)             │   │
│  │                                          │                               │   │
│  │                     Wait 30s ◄───────────┘                               │   │
│  │                         │                                                │   │
│  │                         ▼                                                │   │
│  │                   HALF-OPEN (retry one)                                  │   │
│  │                         │                                                │   │
│  │              ┌──────────┴──────────┐                                    │   │
│  │              ▼                     ▼                                    │   │
│  │         Success               Failure                                   │   │
│  │         CLOSED                OPEN again                                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  VALIDACIONES:                                                                   │
│  ☑ Eventos con UUID único                                                       │
│  ☑ Vector clock actualizado en cada operación                                  │
│  ☑ Conflictos detectados y almacenados                                         │
│  ☑ Reintentos con exponential backoff                                          │
│  ☑ Circuit breaker previene cascading failures                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. FLUJO DE FACTURACIÓN FISCAL

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      CHECKPOINT: FACTURACIÓN FISCAL                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐            │
│  │                     FiscalInvoicesPage                           │            │
│  └──────────────────────────────┬──────────────────────────────────┘            │
│                                 │                                               │
│         ┌───────────────────────┼───────────────────────┐                       │
│         ▼                       ▼                       ▼                       │
│  ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐            │
│  │Crear desde Venta │   │  Ver Detalle     │   │  Configuración   │            │
│  │                  │   │                  │   │  Fiscal          │            │
│  └────────┬─────────┘   └──────────────────┘   └────────┬─────────┘            │
│           │                                             │                       │
│           ▼                                             ▼                       │
│  ┌──────────────────────────┐               ┌──────────────────────┐           │
│  │CreateFiscalInvoiceFrom   │               │  FiscalConfigPage    │           │
│  │SaleModal                 │               │                      │           │
│  │                          │               │ ┌──────────────────┐ │           │
│  │ ┌──────────────────────┐ │               │ │ RIF empresa      │ │           │
│  │ │ sale_id (vinculada)  │ │               │ │ Razón social     │ │           │
│  │ │ customer (con RIF)   │ │               │ │ Series facturas  │─┼──┐        │
│  │ │ serie_factura        │ │               │ │ Impuestos        │ │  │        │
│  │ │ numero_control       │ │               │ └──────────────────┘ │  │        │
│  │ │ items con IVA        │ │               └──────────────────────┘  │        │
│  │ └──────────────────────┘ │                                         │        │
│  └───────────┬──────────────┘                                         │        │
│              │                                         ┌──────────────┘        │
│              ▼                                         ▼                       │
│  ┌──────────────────────────┐               ┌──────────────────────┐           │
│  │  Factura Fiscal Creada   │               │  InvoiceSeriesModal  │           │
│  │                          │               │                      │           │
│  │ ┌──────────────────────┐ │               │ ┌──────────────────┐ │           │
│  │ │ invoice_id           │ │               │ │ prefijo          │ │           │
│  │ │ numero_factura       │ │               │ │ numero_actual    │ │           │
│  │ │ numero_control       │ │               │ │ tipo (factura,   │ │           │
│  │ │ total + IVA          │ │               │ │  nota credito)   │ │           │
│  │ │ linked_sale_id       │ │               │ └──────────────────┘ │           │
│  │ └──────────────────────┘ │               └──────────────────────┘           │
│  └──────────────────────────┘                                                   │
│                                                                                  │
│  FLUJO DESDE VENTA:                                                             │
│                                                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │   Venta     │───►│ Cliente con │───►│   Generar   │───►│  Imprimir   │      │
│  │  Completada │    │ Datos Fiscales   │  Factura    │    │  Factura    │      │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘      │
│                                                                                  │
│  VALIDACIONES:                                                                   │
│  ☑ Cliente con RIF/Cédula válido                                               │
│  ☑ Serie de factura configurada                                                │
│  ☑ Número de control consecutivo                                               │
│  ☑ IVA calculado correctamente                                                 │
│  ☑ Venta no puede tener múltiples facturas                                     │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. FLUJO DE CONTABILIDAD

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       CHECKPOINT: CONTABILIDAD                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐            │
│  │                      AccountingPage                              │            │
│  └──────────────────────────────┬──────────────────────────────────┘            │
│                                 │                                               │
│    ┌────────────┬───────────────┼───────────────┬────────────┐                 │
│    ▼            ▼               ▼               ▼            ▼                 │
│ ┌────────┐ ┌────────┐    ┌────────────┐   ┌────────┐   ┌────────┐             │
│ │ Cuentas│ │Asientos│    │  Mapeos    │   │Exportar│   │  ERP   │             │
│ │        │ │        │    │            │   │        │   │  Sync  │             │
│ └───┬────┘ └───┬────┘    └─────┬──────┘   └───┬────┘   └────────┘             │
│     │          │               │              │                                │
│     ▼          ▼               ▼              ▼                                │
│ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐                   │
│ │AccountForm │ │EntryForm   │ │MappingForm │ │ExportForm  │                   │
│ │Modal       │ │Modal       │ │Modal       │ │Modal       │                   │
│ │            │ │            │ │            │ │            │                   │
│ │┌──────────┐│ │┌──────────┐│ │┌──────────┐│ │┌──────────┐│                   │
│ ││ codigo   ││ ││ fecha    ││ ││ cuenta   ││ ││ periodo  ││                   │
│ ││ nombre   ││ ││ concepto ││ ││ tipo_mov ││ ││ formato  ││                   │
│ ││ tipo     ││ ││ lineas[] ││ ││ mapeo    ││ ││ filtros  ││                   │
│ ││ padre?   ││ ││ debe=haber│ ││          ││ ││          ││                   │
│ │└──────────┘│ │└──────────┘│ │└──────────┘│ │└──────────┘│                   │
│ └────────────┘ └─────┬──────┘ └────────────┘ └────────────┘                   │
│                      │                                                         │
│                      ▼                                                         │
│              ┌────────────────┐                                               │
│              │EntryDetailModal│                                               │
│              │                │                                               │
│              │ ┌────────────┐ │                                               │
│              │ │ Ver asiento│ │                                               │
│              │ │ completo   │ │                                               │
│              │ │ con lineas │ │                                               │
│              │ └────────────┘ │                                               │
│              └────────────────┘                                               │
│                                                                                  │
│  GENERACIÓN AUTOMÁTICA DE ASIENTOS:                                            │
│                                                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                         │
│  │   Venta     │───►│   Mapeo     │───►│  Asiento    │                         │
│  │  Registrada │    │  Automático │    │ Contable    │                         │
│  └─────────────┘    └─────────────┘    └─────────────┘                         │
│                                                                                  │
│  VALIDACIONES:                                                                   │
│  ☑ Plan de cuentas jerárquico válido                                           │
│  ☑ Asientos balanceados (Debe = Haber)                                         │
│  ☑ Mapeos configurados para cada tipo de movimiento                            │
│  ☑ Exportación con formato estándar                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 11. FLUJO DE ANALYTICS Y ML

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      CHECKPOINT: ANALYTICS Y ML                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐            │
│  │                       DashboardPage                              │            │
│  └──────────────────────────────┬──────────────────────────────────┘            │
│                                 │                                               │
│    ┌──────────────┬─────────────┼─────────────┬──────────────┐                 │
│    ▼              ▼             ▼             ▼              ▼                 │
│ ┌────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│ │Realtime│  │ Reports  │  │   ML     │  │Anomalies │  │ Heatmap  │            │
│ │Analytics│  │          │  │Dashboard │  │          │  │          │            │
│ └───┬────┘  └──────────┘  └────┬─────┘  └────┬─────┘  └──────────┘            │
│     │                          │             │                                 │
│     ▼                          │             ▼                                 │
│ ┌────────────────┐             │    ┌────────────────┐                        │
│ │RealtimeAnalytics             │    │ AnomaliesPage  │                        │
│ │Page            │             │    │                │                        │
│ │                │             │    │ ┌────────────┐ │                        │
│ │ ┌────────────┐ │             │    │ │ Anomalía   │ │                        │
│ │ │ WebSocket  │ │             │    │ │ detectada  │ │                        │
│ │ │ Live Data  │ │             │    │ └─────┬──────┘ │                        │
│ │ │            │ │             │    │       │        │                        │
│ │ │ - ventas/h │ │             │    │       ▼        │                        │
│ │ │ - clientes │ │             │    │ ┌────────────┐ │                        │
│ │ │ - productos│ │             │    │ │ResolveAnoma│ │                        │
│ │ └────────────┘ │             │    │ │lyModal     │ │                        │
│ └────────────────┘             │    │ │            │ │                        │
│                                │    │ │ ┌────────┐ │ │                        │
│              ┌─────────────────┘    │ │ │acción  │ │ │                        │
│              ▼                      │ │ │notas   │ │ │                        │
│     ┌────────────────┐              │ │ │resolver│ │ │                        │
│     │  MLDashboard   │              │ │ └────────┘ │ │                        │
│     │     Page       │              │ └────────────┘ │                        │
│     │                │              └────────────────┘                        │
│     │ ┌────────────┐ │                                                        │
│     │ │Predicciones│ │                                                        │
│     │ │ de demanda │ │                                                        │
│     │ │            │ │                                                        │
│     │ │ Productos  │ │                                                        │
│     │ │ a reabastecer │                                                        │
│     │ └────────────┘ │                                                        │
│     └────────────────┘                                                        │
│                                                                                  │
│  FLUJO DE ML:                                                                   │
│                                                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │  Datos de   │───►│  Modelo ML  │───►│ Predicción  │───►│ Sugerencia  │      │
│  │   Ventas    │    │ (Backend)   │    │ Generada    │    │  Usuario    │      │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘      │
│                                                                                  │
│  VALIDACIONES:                                                                   │
│  ☑ WebSocket conectado para datos realtime                                     │
│  ☑ Predicciones basadas en datos históricos                                    │
│  ☑ Anomalías requieren resolución manual                                       │
│  ☑ Alertas configurables por umbral                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 12. MATRIZ DE INTERCONEXIÓN DE MODALES

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    MATRIZ DE DEPENDENCIAS ENTRE MODALES                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  MODAL ORIGEN          │  PUEDE ABRIR           │  DATOS QUE PASA              │
│  ─────────────────────────────────────────────────────────────────────────────  │
│                                                                                  │
│  CheckoutModal         │  CustomerFormModal     │  customer_id (retorno)       │
│                        │  DiscountAuthModal     │  discount_config             │
│                        │  SplitPaymentModal     │  payments[], total           │
│                        │  CreateFiscalInvoice   │  sale_id                     │
│                                                                                  │
│  ProductFormModal      │  ProductVariantsModal  │  product_id, variants[]      │
│                        │  ProductLotsModal      │  product_id, lots[]          │
│                        │  ProductSerialsModal   │  product_id, serials[]       │
│                                                                                  │
│  OrderModal            │  OrderItemModal        │  order_item                  │
│                        │  PartialPaymentModal   │  order_id, pending_amount    │
│                        │  CheckoutModal         │  order → sale conversion     │
│                                                                                  │
│  PurchaseOrderForm     │  N/A                   │  supplier_id, products[]     │
│  PurchaseOrderDetail   │  ReceptionModal        │  po_id, items_pending[]      │
│                                                                                  │
│  DebtDetailModal       │  AddPaymentModal       │  debt_id, balance            │
│                                                                                  │
│  InventoryPage         │  StockReceivedModal    │  product_id, warehouse_id    │
│                        │  StockAdjustModal      │  product_id, current_stock   │
│                        │  MovementsModal        │  product_id, movements[]     │
│                                                                                  │
│  CashPage              │  OpenCashModal         │  initial_amounts             │
│                        │  CloseCashModal        │  session_id, expected        │
│                        │  CashMovementModal     │  session_id, type            │
│                        │  CashSessionDetail     │  session_id                  │
│                                                                                  │
│  SalesPage             │  SaleDetailModal       │  sale_id                     │
│  SaleDetailModal       │  CreateFiscalInvoice   │  sale_id, customer           │
│                                                                                  │
│  AccountingPage        │  AccountFormModal      │  account (edit) / null       │
│                        │  EntryFormModal        │  entry (edit) / null         │
│                        │  EntryDetailModal      │  entry_id                    │
│                        │  MappingFormModal      │  mapping (edit) / null       │
│                        │  ExportFormModal       │  filters                     │
│                                                                                  │
│  TablesPage            │  TableModal            │  table (config)              │
│                        │  OrderModal            │  table_id, order?            │
│                                                                                  │
│  AnomaliesPage         │  ResolveAnomalyModal   │  anomaly_id, details         │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 13. STORES Y FLUJO DE DATOS GLOBAL

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       GESTIÓN DE ESTADO GLOBAL                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         ZUSTAND STORES                                   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌─────────────────────────┐                                                   │
│  │      auth.store.ts      │                                                   │
│  │  ┌───────────────────┐  │                                                   │
│  │  │ user: AuthUser    │  │  ◄──── Login/Logout                              │
│  │  │ token: string     │  │  ◄──── Refresh Token                             │
│  │  │ store_id: string  │  │  ◄──── Multi-tienda                              │
│  │  │ role: Role        │  │  ◄──── Permisos                                  │
│  │  └───────────────────┘  │                                                   │
│  │                         │                                                   │
│  │  Acciones:              │                                                   │
│  │  - login()              │                                                   │
│  │  - logout()             │                                                   │
│  │  - setUser()            │                                                   │
│  │  - refreshToken()       │                                                   │
│  └────────────┬────────────┘                                                   │
│               │                                                                 │
│               │ Usado por: Todos los servicios (API headers)                   │
│               │            App.tsx (rutas protegidas)                          │
│               │            Componentes (mostrar usuario)                       │
│               ▼                                                                 │
│  ┌─────────────────────────┐                                                   │
│  │      cart.store.ts      │                                                   │
│  │  ┌───────────────────┐  │                                                   │
│  │  │ items: CartItem[] │  │  ◄──── Productos añadidos                        │
│  │  │ customer: Customer│  │  ◄──── Cliente seleccionado                      │
│  │  │ discounts: []     │  │  ◄──── Descuentos aplicados                      │
│  │  └───────────────────┘  │                                                   │
│  │                         │                                                   │
│  │  Acciones:              │                                                   │
│  │  - addItem()            │                                                   │
│  │  - updateItem()         │                                                   │
│  │  - removeItem()         │                                                   │
│  │  - setCustomer()        │                                                   │
│  │  - applyDiscount()      │                                                   │
│  │  - clear()              │                                                   │
│  │  - getTotal()           │                                                   │
│  └────────────┬────────────┘                                                   │
│               │                                                                 │
│               │ Usado por: POSPage, CheckoutModal, CartComponent               │
│               ▼                                                                 │
│  ┌─────────────────────────┐                                                   │
│  │  notifications.store.ts │                                                   │
│  │  ┌───────────────────┐  │                                                   │
│  │  │ toasts: Toast[]   │  │  ◄──── Notificaciones UI                         │
│  │  └───────────────────┘  │                                                   │
│  └─────────────────────────┘                                                   │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         REACT QUERY CACHE                                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  Query Keys:                                                                    │
│  ┌────────────────────────────────────────────────────────────────────────┐    │
│  │  ['products']              │  Lista de productos                        │    │
│  │  ['products', id]          │  Producto específico                       │    │
│  │  ['sales']                 │  Historial de ventas                       │    │
│  │  ['sales', id]             │  Venta específica                          │    │
│  │  ['customers']             │  Lista de clientes                         │    │
│  │  ['debts']                 │  Deudas pendientes                         │    │
│  │  ['cash-session']          │  Sesión de caja actual                     │    │
│  │  ['inventory', product_id] │  Stock por producto                        │    │
│  │  ['exchange-rate']         │  Tasa de cambio actual                     │    │
│  │  ['fiscal-invoices']       │  Facturas fiscales                         │    │
│  │  ['purchase-orders']       │  Órdenes de compra                         │    │
│  │  ['predictions']           │  Predicciones ML                           │    │
│  │  ['anomalies']             │  Anomalías detectadas                      │    │
│  └────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         INDEXED DB (DEXIE)                               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  Tablas:                                                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐    │
│  │  localEvents   │  Cola de eventos para sync                            │    │
│  │  products      │  Cache de productos                                   │    │
│  │  customers     │  Cache de clientes                                    │    │
│  │  sales         │  Ventas offline                                       │    │
│  │  conflicts     │  Conflictos de sync                                   │    │
│  │  kv            │  Key-Value store general                              │    │
│  └────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 14. VALIDACIONES CRÍTICAS POR FLUJO

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    CHECKLIST DE VALIDACIONES CRÍTICAS                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                           VENTAS (POS)                                     ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════╝ │
│  □ Sesión de caja abierta                                                       │
│  □ Stock suficiente para todos los productos                                    │
│  □ Precios actualizados (verificar tasa de cambio)                             │
│  □ Productos serializados tienen serial capturado                              │
│  □ Productos por peso tienen peso válido > 0                                   │
│  □ Descuentos autorizados si superan umbral                                    │
│  □ Método de pago configurado y activo                                         │
│  □ Monto recibido >= total (si efectivo)                                       │
│  □ Cliente con datos fiscales si factura requerida                             │
│  □ Cambio calculado correctamente                                              │
│                                                                                  │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                          INVENTARIO                                        ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════╝ │
│  □ Código/barcode único                                                         │
│  □ Stock no puede ser negativo                                                  │
│  □ Ajustes documentados con motivo                                             │
│  □ Recepciones vinculadas a orden de compra                                    │
│  □ Seriales únicos globalmente                                                 │
│  □ Lotes con información de vencimiento                                        │
│  □ Almacén válido y activo                                                     │
│                                                                                  │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                            CAJA                                            ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════╝ │
│  □ Solo una sesión activa por usuario                                          │
│  □ Monto inicial registrado                                                    │
│  □ Conteo físico al cerrar                                                     │
│  □ Diferencias documentadas                                                    │
│  □ Movimientos con concepto válido                                             │
│                                                                                  │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                           CLIENTES                                         ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════╝ │
│  □ RIF/Cédula único                                                            │
│  □ Límite de crédito respetado                                                 │
│  □ Datos fiscales completos para facturación                                  │
│                                                                                  │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                           DEUDAS                                           ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════╝ │
│  □ Pagos no exceden saldo pendiente                                            │
│  □ Método de pago válido                                                       │
│  □ Referencia de pago cuando aplica                                            │
│                                                                                  │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                      ÓRDENES DE COMPRA                                     ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════╝ │
│  □ Proveedor activo                                                            │
│  □ Productos existen en catálogo                                               │
│  □ Cantidades recibidas <= ordenadas                                           │
│  □ Recepción actualiza stock                                                   │
│                                                                                  │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                      FACTURACIÓN FISCAL                                    ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════╝ │
│  □ Configuración fiscal completa                                               │
│  □ Serie de factura configurada                                                │
│  □ Número de control consecutivo                                               │
│  □ Cliente con RIF válido                                                      │
│  □ IVA calculado correctamente                                                 │
│  □ Una factura por venta máximo                                                │
│                                                                                  │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                        CONTABILIDAD                                        ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════╝ │
│  □ Plan de cuentas válido                                                      │
│  □ Asientos balanceados (Debe = Haber)                                         │
│  □ Cuentas existen antes de usarlas                                            │
│  □ Mapeos configurados para automatización                                     │
│                                                                                  │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                       SINCRONIZACIÓN                                       ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════╝ │
│  □ Eventos con UUID único                                                       │
│  □ Vector clock consistente                                                    │
│  □ Conflictos resueltos antes de continuar                                     │
│  □ Reintentos con backoff exponencial                                          │
│  □ Circuit breaker funcionando                                                 │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 15. RESUMEN EJECUTIVO

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           RESUMEN DEL SISTEMA                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ESTADÍSTICAS:                                                                   │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  Páginas principales:          38                                        │  │
│  │  Modales:                      50                                        │  │
│  │  Servicios (PWA):              47+                                       │  │
│  │  Entidades DB:                 80+                                       │  │
│  │  Custom Hooks:                 22+                                       │  │
│  │  Módulos API:                  48                                        │  │
│  │  Stores Zustand:               3                                         │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  FLUJOS CRÍTICOS:                                                               │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  1. VENTAS (POS)         → Flujo más crítico del negocio                 │  │
│  │  2. SINCRONIZACIÓN       → Garantiza consistencia offline-first          │  │
│  │  3. CAJA                 → Control financiero diario                     │  │
│  │  4. INVENTARIO           → Gestión de stock en tiempo real               │  │
│  │  5. FACTURACIÓN FISCAL   → Cumplimiento legal                            │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  ARQUITECTURA:                                                                   │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  • Monorepo con 3 apps y 3 packages                                      │  │
│  │  • Frontend: React + Zustand + React Query + Dexie                       │  │
│  │  • Backend: NestJS + TypeORM + PostgreSQL                                │  │
│  │  • Sync: Event Sourcing + Vector Clocks + Circuit Breaker                │  │
│  │  • Real-time: Socket.io + WebSocket                                      │  │
│  │  • ML: Predicción de demanda + Detección de anomalías                    │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│  PUNTOS DE INTEGRACIÓN:                                                         │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  • CheckoutModal ↔ CustomerFormModal ↔ CreateFiscalInvoiceModal          │  │
│  │  • ProductFormModal ↔ VariantsModal ↔ LotsModal ↔ SerialsModal           │  │
│  │  • OrderModal ↔ OrderItemModal ↔ PartialPaymentModal ↔ CheckoutModal     │  │
│  │  • CashPage ↔ OpenCashModal ↔ CashMovementModal ↔ CloseCashModal         │  │
│  │  • PurchaseOrderModal ↔ ReceptionModal → InventoryUpdate                 │  │
│  │  • SaleDetailModal ↔ CreateFiscalInvoiceModal                            │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

**Documento generado para LA-CAJA POS System**
**Versión: 1.0**
**Fecha: Enero 2026**
